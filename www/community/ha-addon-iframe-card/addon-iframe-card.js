(function(f){typeof define=="function"&&define.amd?define(f):f()})(function(){"use strict";const f=window.loadCardHelpers,w=s=>{const e=window;(e.customCards||(e.customCards=[])).push(s)},_=async(s,e)=>{let r=null;try{r=await s.callWS({type:"supervisor/api",endpoint:`/addons/${e}/info`,method:"get"})}catch{}return r},m=s=>(document.cookie=`ingress_session=${s};path=/api/hassio_ingress/;SameSite=Strict${location.protocol==="https:"?";Secure":""}`,s),g=async s=>{const e=await s.callWS({type:"supervisor/api",endpoint:"/ingress/session",method:"post"});return m(e.session)},C=async(s,e)=>{await s.callWS({type:"supervisor/api",endpoint:"/ingress/validate_session",method:"post",data:{session:e}}),m(e)};let c=window.__ingressSession;if(!c){const s=()=>({session:"",refCount:0});let e=s();c=window.__ingressSession={get session(){return e.session},get refCount(){return e.refCount},async init(r){if(!r)return!1;if(e.hass=r,e.timer===void 0){try{e.session=await g(r)}catch{return!1}e.timer===void 0&&(e.timer=setInterval(async()=>{const u=e.hass;try{await C(u,e.session)}catch{e.session=await g(u)}},6e4),e.refCount=0)}return++e.refCount,!0},fini(){e.timer!==void 0&&(--e.refCount,clearTimeout(e.finiTimer),e.finiTimer=setTimeout(()=>{delete e.finiTimer,e.refCount<=0&&e.timer!==void 0&&(clearInterval(e.timer),e=s())},6e4))}}}const h="hui-iframe-card",l="iframe",p="addon-iframe-card",y=`custom:${p}`;(async()=>{let s=customElements.get(h);s===void 0&&((await f()).createCardElement({type:l}),await customElements.whenDefined(h),s=customElements.get(h));const e=s;class r extends e{constructor(){super(...arguments),this._data={}}static getStubConfig(){const t=super.getStubConfig();return t.type=y,t}connectedCallback(){this._data.isIngress&&c.init(this.hass),super.connectedCallback()}disconnectedCallback(){super.disconnectedCallback(),this._data.isIngress&&c.fini()}set hass(t){super.hass=t,this._data.config&&this._data.config.type!==l&&this._setConfig(t,this._data.config)}get hass(){return super.hass}setConfig(t){if(!t.url)throw new Error("URL required");const i=this.hass;i?this._setConfig(i,t):this._data.config=t}async _setConfig(t,i){i=(()=>{const{type:a,...o}=i;return(!this._data.config||this._data.config.type!==l)&&(this._data.config={type:l}),Object.assign(this._data.config,o)})();const n=await this._fixConfig(t,i);if(n&&!await c.init(t))throw new Error("Unable to create an Ingress session");this._data.isIngress&&(c.fini(),delete this._data.isIngress),n&&(this._data.isIngress=!0,this.isConnected||c.fini()),await this._fixAppShow(t,i.url),super.setConfig(i)}async _fixConfig(t,i){if(/^((\w+:)?\/\/[^/]+)?\/api\/hassio_ingress\/[^/]+/.test(i.url))return!0;const n=i.url.match(/^([\w-]+)(?:$|\/)(.*)/);if(!n)return!1;const[,a,o]=n,d=await _(t,a);if(!d)throw new Error(`Unable to fetch add-on info of '${a}'`);if(!d.ingress_url)throw new Error(`Add-on '${a}' does not support Ingress`);return i.url=`${d.ingress_url.replace(/\/+$/,"")}/${o}`,!0}async _fixAppShow(t,i){try{if(!window.externalApp&&!window.webkit||!i.startsWith("/api/ingress/"))return;const n=await fetch(i);if(!n.ok||!n.redirected)return;const a=new URL(n.url);if(a.origin!==location.origin||!a.searchParams.has("replace"))return;const o=document.createElement("partial-panel-resolver");o.hass=t,o.route={prefix:"",path:a.pathname};const d=this.shadowRoot||this;d.appendChild(o),await new Promise(I=>setTimeout(I,1e3)),d.removeChild(o)}catch{}}}customElements.define(p,r),w({type:p,name:"Ingress webpage",description:"Webpage card with addon ingress support.",documentationURL:"https://github.com/lovelylain/ha-addon-iframe-card"})})()});
